only_one <- ps_data %>%
filter(num_sources == 1)
only_one <- rename_source(only_one, n_val = 9)
# manual replace list:
only_one <- only_one %>%
mutate(zip_id = recode(zip_id,
"05852" = "05851",
"05402" = "05401",
"05246" = "05346",
"05378" = "05478",
"05467" = "05408",
"05856" = "05647",
"04503" = "05403",
"05402" = "05452",
"05750" = "05735",
"05462" = "05461",
"05671" = "05661"
))
list(only_one, more_than_one)
}
gather_p4 <- function(p4_data) {
df <- p4_data %>%
mutate(num_sources = rowSums(across(starts_with("recruit_1")), na.rm = TRUE))
only_one <- df %>% filter(num_sources == 1)
only_one <- rename_source(only_one, n_val = 1)
more_than_one <- df %>%
filter(num_sources > 1) %>%
select(!starts_with("recruit_1___"))
more_than_one$source <- "multiple"
rbind(only_one, more_than_one)
}
join_crosswalk <- function(ps_sub) {
ps_sub %>%
mutate(zip_id = as.numeric(zip_id)) %>%
left_join(
read.csv("./data/zipcodes.csv", stringsAsFactors = FALSE),
by = c("zip_id" = "ZIP")
)
}
recode_flyer <- function(ps_location) {
# participants often confuse "flyer" with "direct_mail." recode
# any flyer_location that suggests direct mailing
pattern <- "mail|mailbox|home|house"
ps_location %>%
mutate(source = ifelse(
!is.na(flyer_location) &
stringr::str_detect(tolower(flyer_location), pattern),
"direct_mail",
source)
)
}
merge_trial_data <- function(ps_location) {
status <- pull_status(build_rcon("rc_proper"))
ps_location %>%
left_join(status, by = c("screen_subjectid" = "screen_id")) %>%
mutate(
randomized = ifelse(!is.na(baseline2_date), "randomized", "not randomized"),
complete = ifelse(sl_status == "Complete", "complete", "not complete"),
complete = ifelse(is.na(complete), "not complete", complete),
screened = ifelse(screened == "yes", "screened", "not screened"),
recruit_int_summ = recode(
recruit_int_summ,
"1" = "screening_scheduled",
"2" = "waiting_list",
"3" = "screening_declined",
"4" = "ineligible",
"5" = "lost_contact",
.default = NA_character_
),
recruit_int_summ = ifelse(
ps_proj_eligible == "ineligible",
"ineligible",
recruit_int_summ
),
rand_proj = ifelse(
randomized == "randomized",
paste("rand:", project),
randomized)
)
}
recode_buildclinical <- function(ps_location, start_date = as.Date("2021-10-22")) {
# BuildClinical took over digital recruitment for the TCORS
# main trial on 10/22/2021
ps_location %>%
mutate(
source = ifelse(
recruit_date >= start_date &
(source == "facebook" | source == "instagram" | source == "google"),
"BuildClinical",
source
)
)
}
p4_data <- recode_buildclinical(ps_location)
View(p4_data)
p4_data <- recode_buildclinical(p4_data)
p4_data <- download_ps_p4()
p4_data <- recode_buildclinical(p4_data)
recode_buildclinical(p4_data)
View(p4_data)
p4 <- gather_p4(p4_data)
View(p4)
p4_data <- recode_buildclinical(p4_data)
p4_data <- recode_buildclinical(p4)
df <- p4_data %>%
mutate(num_sources = rowSums(across(starts_with("recruit_1")), na.rm = TRUE))
View(df)
p4_data <- download_ps_p4()
df <- p4_data %>%
mutate(num_sources = rowSums(across(starts_with("recruit_1")), na.rm = TRUE))
only_one <- df %>% filter(num_sources == 1)
only_one <- rename_source(only_one, n_val = 1)
View(only_one)
only_one <- df %>% filter(num_sources == 1)
View(only_one)
df %>% filter(num_sources == 1)
only_one <- df %>%
filter(num_sources == 1) %>%
select(everything(), recruit_int_summ)
only_one <- rename_source(only_one, n_val = 2)
View(only_one)
only_one <- df %>%
filter(num_sources == 1) %>%
select(everything(), recruit_int_summ)
View(only_one)
only_one <- df %>%
filter(num_sources == 1) %>%
select(-recruit_int_summ, recruit_int_summ)
only_one <- rename_source(only_one, n_val = 2)
View(only_one)
more_than_one <- df %>%
filter(num_sources > 1) %>%
select(!starts_with("recruit_1___"))
more_than_one$source <- "multiple"
rbind(only_one, more_than_one)
gather_p4 <- function(p4_data) {
df <- p4_data %>%
mutate(num_sources = rowSums(across(starts_with("recruit_1")), na.rm = TRUE))
only_one <- df %>%
filter(num_sources == 1) %>%
select(-recruit_int_summ, recruit_int_summ)
only_one <- rename_source(only_one, n_val = 2)
more_than_one <- df %>%
filter(num_sources > 1) %>%
select(!starts_with("recruit_1___"))
more_than_one$source <- "multiple"
rbind(only_one, more_than_one)
}
p4 <- gather_p4(p4_data)
recode_buildclinical(p4)
recode_buildclinical <- function(ps_location, start_date = as.Date("2021-10-22")) {
# BuildClinical took over digital recruitment for the TCORS
# main trial on 10/22/2021
ps_location %>%
mutate(
source = ifelse(
as.Date(recruit_date) >= start_date &
(source == "facebook" | source == "instagram" | source == "google"),
"BuildClinical",
source
)
)
}
recode_buildclinical(p4)
clean_ps(p4_data)
p4_data <- clean_ps(p4_data)
View(p4_data)
clean_ps
p4_data <- download_ps_p4()
clean_ps(p4_data, start_date = as.Date("2019-01-01"))
t<- clean_ps(p4_data, start_date = as.Date("2019-01-01"))
View(t)
clean_ps <- function(ps_df, start_date = as.Date("2020-10-01")) {
# Filter out pre-screen records flagged as duplicate, error, or
# having a date outside of the acceptable range.
filter_str <- "-|_|copy|incomplete|empty|TEST|test"
ps_df %>%
filter(
!stringr::str_detect(redcap_id, filter_str),
!is.na(recruit_date),
as.Date(recruit_date) > start_date
)
}
View(ps_location)
merge(p4_data, ps_location)
p4 <- recode_buildclinical(p4)
merge(p4, ps_location)
c(p4, ps_location)
plot_main <- ps_location %>%
select(
redcap_id, recruit_date, source, recruit_int_summ,
ps_proj_eligible, screened, sl_status,
randomized, complete, rand_proj
)
plot_p4 <- p4 %>%
select(
redcap_id, recruit_date, source, recruit_int_summ
) %>%
mutate(
ps_proj_eligible = NA,
screened = NA,
sl_status = NA,
randomized = NA,
complete = NA,
rand_proj = NA
)
View(p4_data)
download_ps_p4 <- function() {
# Project 4's REDCap project is structured differently,
# which requires a different approach.
rcon_ps_p4 <- build_rcon("rc_prescreen_p4")
# rcon_id_p4 <- build_rcon("rd_id_info_p4")
ps_fields <- c(
"redcap_id", "recruit_identinfo_id", "recruit_date",
"recruit_int_summ", "recruit_1",
"recruit_3", "recruit_4", "recruit_4a", "recruit_5",
"recruit_6", "recruit_7", "recruit_7a", "recruit_8",
"recruit_9", "recruit_10", "recruit_11", "recruit_12",
"recruit_13", "recruit_14", "recruit_15"
)
df_ps <- download_ps(rcon_ps_p4, fields = ps_fields)
df_ps %>%
mutate(elig_project_4 = ifelse(
recruit_3 == 1 &
(recruit_4 == 0 |
(recruit_4 == 1 & recruit_4a < 10)) &
recruit_5 == 0 &
recruit_6 == 0 &
recruit_7a == 0 &
(recruit_8 == 0 | recruit_8 == 7777) &
recruit_9 == 0 &
recruit_10 == 0 &
(recruit_11 > 17 & recruit_11 < 45) &
recruit_12 == 1 &
recruit_13 == 1 &
recruit_14 < 26 &
recruit_15 %in% 1:4,
1, 0
)) %>%
select(
redcap_id, recruit_identinfo_id, recruit_date,
recruit_int_summ, elig_project_4, starts_with("recruit_1___")
)
}
p4_data <- download_ps_p4()
p4_data <- clean_ps(p4_data, start_date = as.Date("2019-01-01"))
p4 <- gather_p4(p4_data)
p4 <- recode_buildclinical(p4)
plot_p4 <- p4 %>%
select(
redcap_id, recruit_date, source, recruit_int_summ,
ps_proj_eligible = elig_project_4
) %>%
mutate(
screened = NA,
sl_status = NA,
randomized = NA,
complete = NA,
rand_proj = NA
)
View(plot_p4)
download_ps_p4 <- function() {
# Project 4's REDCap project is structured differently,
# which requires a different approach.
rcon_ps_p4 <- build_rcon("rc_prescreen_p4")
# rcon_id_p4 <- build_rcon("rd_id_info_p4")
ps_fields <- c(
"redcap_id", "recruit_identinfo_id", "recruit_date",
"recruit_int_summ", "recruit_1",
"recruit_3", "recruit_4", "recruit_4a", "recruit_5",
"recruit_6", "recruit_7", "recruit_7a", "recruit_8",
"recruit_9", "recruit_10", "recruit_11", "recruit_12",
"recruit_13", "recruit_14", "recruit_15"
)
df_ps <- download_ps(rcon_ps_p4, fields = ps_fields)
df_ps %>%
mutate(elig_project_4 = ifelse(
recruit_3 == 1 &
(recruit_4 == 0 |
(recruit_4 == 1 & recruit_4a < 10)) &
recruit_5 == 0 &
recruit_6 == 0 &
recruit_7a == 0 &
(recruit_8 == 0 | recruit_8 == 7777) &
recruit_9 == 0 &
recruit_10 == 0 &
(recruit_11 > 17 & recruit_11 < 45) &
recruit_12 == 1 &
recruit_13 == 1 &
recruit_14 < 26 &
recruit_15 %in% 1:4,
"Project 4", "ineligible"
)) %>%
select(
redcap_id, recruit_identinfo_id, recruit_date,
recruit_int_summ, elig_project_4, starts_with("recruit_1___")
)
}
p4_data <- download_ps_p4()
p4_data <- clean_ps(p4_data, start_date = as.Date("2019-01-01"))
p4 <- gather_p4(p4_data)
p4 <- recode_buildclinical(p4)
plot_p4 <- p4 %>%
select(
redcap_id, recruit_date, source, recruit_int_summ,
ps_proj_eligible = elig_project_4
) %>%
mutate(
screened = NA,
sl_status = NA,
randomized = NA,
complete = NA,
rand_proj = NA
)
plot_df <- rbind(plot_main, plot_p4)
View(plot_df)
download_ps_p4 <- function() {
# Project 4's REDCap project is structured differently,
# which requires a different approach.
rcon_ps_p4 <- build_rcon("rc_prescreen_p4")
# rcon_id_p4 <- build_rcon("rd_id_info_p4")
ps_fields <- c(
"redcap_id", "recruit_identinfo_id", "recruit_date",
"recruit_int_summ", "recruit_1",
"recruit_3", "recruit_4", "recruit_4a", "recruit_5",
"recruit_6", "recruit_7", "recruit_7a", "recruit_8",
"recruit_9", "recruit_10", "recruit_11", "recruit_12",
"recruit_13", "recruit_14", "recruit_15"
)
df_ps <- download_ps(rcon_ps_p4, fields = ps_fields)
df_ps %>%
mutate(elig_project_4 = ifelse(
recruit_3 == 1 &
(recruit_4 == 0 |
(recruit_4 == 1 & recruit_4a < 10)) &
recruit_5 == 0 &
recruit_6 == 0 &
recruit_7a == 0 &
(recruit_8 == 0 | recruit_8 == 7777) &
recruit_9 == 0 &
recruit_10 == 0 &
(recruit_11 > 17 & recruit_11 < 45) &
recruit_12 == 1 &
recruit_13 == 1 &
recruit_14 < 26 &
recruit_15 %in% 1:4,
"Project 4", "ineligible"
),
recruit_int_summ = redcapFactorFlip(recruit_int_summ)
) %>%
select(
redcap_id, recruit_identinfo_id, recruit_date,
recruit_int_summ, elig_project_4, starts_with("recruit_1___")
)
}
p4_data <- download_ps_p4()
p4_data <- clean_ps(p4_data, start_date = as.Date("2019-01-01"))
p4 <- gather_p4(p4_data)
p4 <- recode_buildclinical(p4)
plot_p4 <- p4 %>%
select(
redcap_id, recruit_date, source, recruit_int_summ,
ps_proj_eligible = elig_project_4
) %>%
mutate(
screened = NA,
sl_status = NA,
randomized = NA,
complete = NA,
rand_proj = NA
)
View(plot_p4)
download_ps_p4 <- function() {
# Project 4's REDCap project is structured differently,
# which requires a different approach.
rcon_ps_p4 <- build_rcon("rc_prescreen_p4")
# rcon_id_p4 <- build_rcon("rd_id_info_p4")
ps_fields <- c(
"redcap_id", "recruit_identinfo_id", "recruit_date",
"recruit_int_summ", "recruit_1",
"recruit_3", "recruit_4", "recruit_4a", "recruit_5",
"recruit_6", "recruit_7", "recruit_7a", "recruit_8",
"recruit_9", "recruit_10", "recruit_11", "recruit_12",
"recruit_13", "recruit_14", "recruit_15"
)
df_ps <- download_ps(rcon_ps_p4, fields = ps_fields)
df_ps %>%
mutate(elig_project_4 = ifelse(
recruit_3 == 1 &
(recruit_4 == 0 |
(recruit_4 == 1 & recruit_4a < 10)) &
recruit_5 == 0 &
recruit_6 == 0 &
recruit_7a == 0 &
(recruit_8 == 0 | recruit_8 == 7777) &
recruit_9 == 0 &
recruit_10 == 0 &
(recruit_11 > 17 & recruit_11 < 45) &
recruit_12 == 1 &
recruit_13 == 1 &
recruit_14 < 26 &
recruit_15 %in% 1:4,
"Project 4", "ineligible"
),
recruit_int_summ = recode(
recruit_int_summ,
"1" = "screening_scheduled",
"2" = "waiting_list",
"3" = "screening_declined",
"4" = "ineligible",
"5" = "lost_contact",
.default = NA_character_
)
) %>%
select(
redcap_id, recruit_identinfo_id, recruit_date,
recruit_int_summ, elig_project_4, starts_with("recruit_1___")
)
}
p4_data <- download_ps_p4()
p4_data <- clean_ps(p4_data, start_date = as.Date("2019-01-01"))
p4 <- gather_p4(p4_data)
p4 <- recode_buildclinical(p4)
plot_p4 <- p4 %>%
select(
redcap_id, recruit_date, source, recruit_int_summ,
ps_proj_eligible = elig_project_4
) %>%
mutate(
screened = NA,
sl_status = NA,
randomized = NA,
complete = NA,
rand_proj = NA
)
download_ps_p4 <- function() {
# Project 4's REDCap project is structured differently,
# which requires a different approach.
rcon_ps_p4 <- build_rcon("rc_prescreen_p4")
# rcon_id_p4 <- build_rcon("rd_id_info_p4")
ps_fields <- c(
"redcap_id", "recruit_identinfo_id", "recruit_date",
"recruit_int_summ", "recruit_1",
"recruit_3", "recruit_4", "recruit_4a", "recruit_5",
"recruit_6", "recruit_7", "recruit_7a", "recruit_8",
"recruit_9", "recruit_10", "recruit_11", "recruit_12",
"recruit_13", "recruit_14", "recruit_15"
)
df_ps <- download_ps(rcon_ps_p4, fields = ps_fields)
df_ps %>%
mutate(elig_project_4 = ifelse(
recruit_3 == 1 &
(recruit_4 == 0 |
(recruit_4 == 1 & recruit_4a < 10)) &
recruit_5 == 0 &
recruit_6 == 0 &
recruit_7a == 0 &
(recruit_8 == 0 | recruit_8 == 7777) &
recruit_9 == 0 &
recruit_10 == 0 &
(recruit_11 > 17 & recruit_11 < 45) &
recruit_12 == 1 &
recruit_13 == 1 &
recruit_14 < 26 &
recruit_15 %in% 1:4,
"Project 4", "ineligible"
),
recruit_int_summ = recode(
as.character(recruit_int_summ),
"1" = "screening_scheduled",
"2" = "waiting_list",
"3" = "screening_declined",
"4" = "ineligible",
"5" = "lost_contact",
.default = NA_character_
)
) %>%
select(
redcap_id, recruit_identinfo_id, recruit_date,
recruit_int_summ, elig_project_4, starts_with("recruit_1___")
)
}
p4_data <- download_ps_p4()
p4_data <- clean_ps(p4_data, start_date = as.Date("2019-01-01"))
p4 <- gather_p4(p4_data)
p4 <- recode_buildclinical(p4)
plot_p4 <- p4 %>%
select(
redcap_id, recruit_date, source, recruit_int_summ,
ps_proj_eligible = elig_project_4
) %>%
mutate(
screened = NA,
sl_status = NA,
randomized = NA,
complete = NA,
rand_proj = NA
)
View(plot_p4)
write.csv(plot_df, "./out/plot_df.csv", row.names = FALSE)
plot_df <- read.csv("./out/plot_df.csv")
runApp()
runApp()
runApp()
View(plot_df)
runApp()
View(plot_df)
ps_proj_list
ps_proj_list <- c(ps_proj_list, "Project 4")
plot_df %>% filter(ps_proj_eligible %in% ps_proj_list)
t <- plot_df %>% filter(ps_proj_eligible %in% ps_proj_list)
View(t)
