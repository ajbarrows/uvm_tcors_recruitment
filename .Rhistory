recruit_int_summ,
"1" = "screening_scheduled",
"2" = "waiting_list",
"3" = "screening_declined",
"4" = "ineligible",
"5" = "lost_contact",
.default = NA_character_
),
recruit_int_summ = ifelse(
ps_proj_eligible == "ineligible",
"ineligible",
recruit_int_summ
),
screen_status = recode(
screen_status,
"1" = "declined_consent",
"2" = "no-show",
"3" = "screened",
.default = NA_character_
),
rand_proj = ifelse(
randomized == "randomized",
paste("rand:", project),
randomized)
)
}
# P4 functions -----------
download_ps_p4 <- function() {
# Project 4's REDCap project is structured differently,
# which requires a different approach.
rcon_ps_p4 <- build_rcon("rc_prescreen_p4")
# rcon_id_p4 <- build_rcon("rd_id_info_p4")
ps_fields <- c(
"redcap_id", "recruit_identinfo_id", "recruit_date",
"recruit_int_summ", "recruit_1",
"recruit_3", "recruit_4", "recruit_4a", "recruit_5",
"recruit_6", "recruit_7", "recruit_7a", "recruit_8",
"recruit_9", "recruit_10", "recruit_11", "recruit_12",
"recruit_13", "recruit_14", "recruit_15"
)
df_ps <- download_ps(rcon_ps_p4, fields = ps_fields)
df_ps %>%
mutate(elig_project_4 = ifelse(
recruit_3 == 1 &
(recruit_4 == 0 |
(recruit_4 == 1 & recruit_4a < 10)) &
recruit_5 == 0 &
recruit_6 == 0 &
recruit_7a == 0 &
(recruit_8 == 0 | recruit_8 == 7777) &
recruit_9 == 0 &
recruit_10 == 0 &
(recruit_11 > 17 & recruit_11 < 45) &
recruit_12 == 1 &
recruit_13 == 1 &
recruit_14 < 26 &
recruit_15 %in% 1:4,
"Project 4", "ineligible"
),
recruit_int_summ = recode(
as.character(recruit_int_summ),
"1" = "screening_scheduled",
"2" = "waiting_list",
"3" = "screening_declined",
"4" = "ineligible",
"5" = "lost_contact",
.default = NA_character_
)
) %>%
select(
redcap_id, recruit_identinfo_id, recruit_date,
recruit_int_summ, elig_project_4, starts_with("recruit_1___")
)
}
gather_p4 <- function(p4_data) {
df <- p4_data %>%
mutate(num_sources = rowSums(across(starts_with("recruit_1")), na.rm = TRUE))
only_one <- df %>%
filter(num_sources == 1) %>%
select(-recruit_int_summ, recruit_int_summ)
only_one <- rename_source(only_one, n_val = 2)
more_than_one <- df %>%
filter(num_sources > 1) %>%
select(!starts_with("recruit_1___"))
more_than_one$source <- "multiple"
rbind(only_one, more_than_one)
}
# main -----
ps_data <- download_ps_data() # API call
# ps_data <- ps_data %>% recode_facebook(as.Date("2021-10-22"), Sys.Date())
p <- gather_ps_data(ps_data)
ps_sub_one <- p[[1]]
ps_sub_multi <- p[[2]]
ps_sub <- rbind(ps_sub_one, ps_sub_multi)
ps_location <- join_crosswalk(ps_sub)
ps_location <- recode_flyer(ps_location)
did_not_merge <- ps_location %>%
filter(is.na(LAT) & !is.na(zip_id)) %>%
select(recruit_date, ps_proj_eligible, source, screened, zip_id, city_id, state_id)
# impose trial data
ps_location <- merge_trial_data(ps_location)
# recode BuildClinical sources
ps_location <- recode_buildclinical(ps_location)
# TODO function
plot_main <- ps_location %>%
select(
redcap_id, recruit_date, source, recruit_int_summ,
ps_proj_eligible, screened, sl_status,
randomized, complete, rand_proj
)
# p4 ------
p4_data <- download_ps_p4()
p4_data <- clean_ps(p4_data, start_date = as.Date("2019-01-01"))
p4 <- gather_p4(p4_data)
p4 <- recode_buildclinical(p4)
plot_p4 <- p4 %>%
select(
redcap_id, recruit_date, source, recruit_int_summ,
ps_proj_eligible = elig_project_4
) %>%
mutate(
screened = NA,
sl_status = NA,
randomized = NA,
complete = NA,
rand_proj = NA
)
# TODO sort of works but not really
plot_df <- rbind(plot_main, plot_p4)
# write to disk
write.csv(ps_location, "./out/ps_locations.csv", row.names = FALSE)
write.csv(did_not_merge, "./out/no_location_data.csv", row.names = FALSE)
write.csv(plot_df, "./out/plot_df.csv", row.names = FALSE)
# timestamp
write.table(Sys.Date(), "./out/lastupdate.txt", row.names = FALSE, col.names = FALSE)
View(ps_location)
t <- ps_location %>%
mutate(recruit_date = as.Date(recruit_date)) %>%
group_by(recruit_date, source, screened, sl_status, ps_proj_eligible, recruit_int_summ, randomized) %>%
count() %>%
ungroup()
n_ps <- ps_location %>%
group_by(source) %>%
count(name = "n_prescreens")
ps_result <- t %>%
select(recruit_date, source, recruit_int_summ, n) %>%
tidyr::pivot_wider(
names_from = recruit_int_summ,
values_from = n,
values_fill = 0,
values_fn = sum
) %>%
rowwise() %>%
mutate(waiting_list = sum(waiting_list, `NA`)) %>%
select(-`NA`)
screen_status <- t %>%
select(recruit_date, source, screen_status, n) %>%
tidyr::drop_na() %>%
tidyr::pivot_wider(
names_from = screen_status,
values_from = n,
values_fill = 0,
values_fn = sum
)
sl_status <- t %>%
select(recruit_date, source, sl_status, n) %>%
tidyr::drop_na() %>%
tidyr::pivot_wider(
names_from = sl_status,
values_from = n,
values_fill = 0,
values_fn = sum
)
# screened <- t %>%
#     select(recruit_date, source, screened, ps_proj_eligible, n) %>%
#     filter(screened == "screened") %>%
#     select(-screened) %>%
#     rename("screened" = n)
randomized <- t %>%
select(recruit_date, source, randomized, ps_proj_eligible, n) %>%
filter(randomized == "randomized") %>%
select(-randomized) %>%
rename("randomized" = n)
tmp <- full_join(ps_result, sl_status)
tmp <- full_join(tmp, randomized)
tab <- full_join(tmp, screened_status)
tab <- full_join(tmp, screen_status)
screen_status <- t %>%
select(recruit_date, source, screen_status, n) %>%
tidyr::drop_na() %>%
tidyr::pivot_wider(
names_from = screen_status,
values_from = n,
values_fill = 0,
values_fn = sum
)
t <- ps_location %>%
mutate(recruit_date = as.Date(recruit_date)) %>%
group_by(recruit_date, source, screened, screen_status, sl_status, ps_proj_eligible, recruit_int_summ, randomized) %>%
count() %>%
ungroup()
n_ps <- ps_location %>%
group_by(source) %>%
count(name = "n_prescreens")
ps_result <- t %>%
select(recruit_date, source, recruit_int_summ, n) %>%
tidyr::pivot_wider(
names_from = recruit_int_summ,
values_from = n,
values_fill = 0,
values_fn = sum
) %>%
rowwise() %>%
mutate(waiting_list = sum(waiting_list, `NA`)) %>%
select(-`NA`)
screen_status <- t %>%
select(recruit_date, source, screen_status, n) %>%
tidyr::drop_na() %>%
tidyr::pivot_wider(
names_from = screen_status,
values_from = n,
values_fill = 0,
values_fn = sum
)
sl_status <- t %>%
select(recruit_date, source, sl_status, n) %>%
tidyr::drop_na() %>%
tidyr::pivot_wider(
names_from = sl_status,
values_from = n,
values_fill = 0,
values_fn = sum
)
randomized <- t %>%
select(recruit_date, source, randomized, ps_proj_eligible, n) %>%
filter(randomized == "randomized") %>%
select(-randomized) %>%
rename("randomized" = n)
tmp <- full_join(ps_result, sl_status)
tmp <- full_join(tmp, randomized)
tab <- full_join(tmp, screen_status)
View(tab)
tab %>%
select(
source,
`total\nprescreens` = n_prescreens,
`prescreen\nineligible` = ineligible,
`screening\ndeclined` = screening_declined,
`awaiting\nresponse` = waiting_list,
`lost\ncontact` = lost_contact,
# `screenings\nupcoming` = screening_scheduled,
`no-show`,
`declined\nconsent` = declined_consent,
`screening\nineligible` = `Screening Ineligible`,
randomized
) %>%
mutate(
across(.cols = -c(source, `total\nprescreens`),
~ paste(.x, " (", round(.x/`total\nprescreens` * 100), "%)", sep =  ""))
) %>%
datatable(rownames = FALSE,
options = list(
columnDefs = list(list(className = 'dt-center', targets = "_all"))
))
t <- ps_location %>%
mutate(recruit_date = as.Date(recruit_date)) %>%
group_by(recruit_date, source, screened, screen_status, sl_status, ps_proj_eligible, recruit_int_summ, randomized) %>%
count() %>%
ungroup()
n_ps <- ps_location %>%
group_by(source) %>%
count(name = "n_prescreens")
ps_result <- t %>%
select(recruit_date, source, recruit_int_summ, n) %>%
tidyr::pivot_wider(
names_from = recruit_int_summ,
values_from = n,
values_fill = 0,
values_fn = sum
) %>%
rowwise() %>%
mutate(waiting_list = sum(waiting_list, `NA`)) %>%
select(-`NA`)
screen_status <- t %>%
select(recruit_date, source, screen_status, n) %>%
tidyr::drop_na() %>%
tidyr::pivot_wider(
names_from = screen_status,
values_from = n,
values_fill = 0,
values_fn = sum
)
sl_status <- t %>%
select(recruit_date, source, sl_status, n) %>%
tidyr::drop_na() %>%
tidyr::pivot_wider(
names_from = sl_status,
values_from = n,
values_fill = 0,
values_fn = sum
)
# screened <- t %>%
#     select(recruit_date, source, screened, ps_proj_eligible, n) %>%
#     filter(screened == "screened") %>%
#     select(-screened) %>%
#     rename("screened" = n)
randomized <- t %>%
select(recruit_date, source, randomized, ps_proj_eligible, n) %>%
filter(randomized == "randomized") %>%
select(-randomized) %>%
rename("randomized" = n)
tmp <- full_join(ps_result, sl_status)
tmp <- full_join(tmp, randomized)
tab <- full_join(tmp, screen_status)
tab <- tab %>%
group_by(source) %>%
summarize(across(.cols = -c(recruit_date, ps_proj_eligible), .fns = sum, na.rm = TRUE)) %>%
ungroup() %>%
full_join(n_ps, by = "source") %>%
rowwise() %>%
mutate(
screening_scheduled = screening_scheduled - screened,
enrolled = `In Progress` + Complete
)
tab %>%
select(
source,
`total\nprescreens` = n_prescreens,
`prescreen\nineligible` = ineligible,
`screening\ndeclined` = screening_declined,
`awaiting\nresponse` = waiting_list,
`lost\ncontact` = lost_contact,
# `screenings\nupcoming` = screening_scheduled,
`no-show`,
`declined\nconsent` = declined_consent,
`screening\nineligible` = `Screening Ineligible`,
randomized
) %>%
mutate(
across(.cols = -c(source, `total\nprescreens`),
~ paste(.x, " (", round(.x/`total\nprescreens` * 100), "%)", sep =  ""))
) %>%
datatable(rownames = FALSE,
options = list(
columnDefs = list(list(className = 'dt-center', targets = "_all"))
))
runApp()
runApp()
runApp()
runApp()
runApp()
runApp()
screen_status <- t %>%
select(recruit_date, source, screen_status, n) %>%
tidyr::drop_na() %>%
tidyr::complete(screen_status) %>%
tidyr::pivot_wider(
names_from = screen_status,
values_from = n,
values_fill = 0,
values_fn = sum
)
View(screen_status)
runApp()
runApp()
ps_location <- ps_location %>% filter(source == "BuildClinical")
t <- ps_location %>%
mutate(recruit_date = as.Date(recruit_date)) %>%
group_by(recruit_date, source, screened, screen_status, sl_status, ps_proj_eligible, recruit_int_summ, randomized) %>%
count() %>%
ungroup()
n_ps <- ps_location %>%
group_by(source) %>%
count(name = "n_prescreens")
ps_result <- t %>%
select(recruit_date, source, recruit_int_summ, n) %>%
tidyr::complete(recruit_int_summ) %>%
tidyr::pivot_wider(
names_from = recruit_int_summ,
values_from = n,
values_fill = 0,
values_fn = sum
) %>%
rowwise() %>%
mutate(waiting_list = sum(waiting_list, `NA`)) %>%
select(-`NA`)
View(ps_result)
screen_status <- t %>%
select(recruit_date, source, screen_status, n) %>%
tidyr::complete(screen_status) %>%
tidyr::pivot_wider(
names_from = screen_status,
values_from = n,
values_fill = 0,
values_fn = sum
)
View(screen_status)
screen_status <- t %>%
select(recruit_date, source, screen_status, n) %>%
tidyr::complete(as.factor(screen_status)) %>%
tidyr::pivot_wider(
names_from = screen_status,
values_from = n,
values_fill = 0,
values_fn = sum
)
screen_status <- t %>%
select(recruit_date, source, factor(screen_status), n) %>%
tidyr::complete() %>%
tidyr::pivot_wider(
names_from = screen_status,
values_from = n,
values_fill = 0,
values_fn = sum
)
t$sl_status
sl_status <- t %>%
select(recruit_date, source, sl_status, n) %>%
tidyr::complete(sl_status) %>%
tidyr::pivot_wider(
names_from = sl_status,
values_from = n,
values_fill = 0,
values_fn = sum
)
View(sl_status)
sl_status <- t %>%
select(recruit_date, source, sl_status, n) %>%
tidyr::drop_na() %>%
tidyr::complete(sl_status) %>%
tidyr::pivot_wider(
names_from = sl_status,
values_from = n,
values_fill = 0,
values_fn = sum
)
View(sl_status)
runApp()
runApp()
ps_location <- ps_location %>% filter(source == "BuildClinical")
t <- ps_location %>%
mutate(recruit_date = as.Date(recruit_date)) %>%
group_by(recruit_date, source, screened, screen_status, sl_status, ps_proj_eligible, recruit_int_summ, randomized) %>%
count() %>%
ungroup()
n_ps <- ps_location %>%
group_by(source) %>%
count(name = "n_prescreens")
ps_result <- t %>%
select(recruit_date, source, recruit_int_summ, n) %>%
tidyr::complete(recruit_int_summ) %>%
tidyr::pivot_wider(
names_from = recruit_int_summ,
values_from = n,
values_fill = 0,
values_fn = sum
) %>%
rowwise() %>%
mutate(waiting_list = sum(waiting_list, `NA`)) %>%
select(-`NA`)
screen_status <- t %>%
select(recruit_date, source, screen_status, n) %>%
tidyr::drop_na() %>%
tidyr::complete(screen_status) %>%
tidyr::pivot_wider(
names_from = screen_status,
values_from = n,
values_fill = 0,
values_fn = sum
)
View(screen_status)
screen_status <- t %>%
select(recruit_date, source, screen_status, n) %>%
mutate(screen_status = factor(
screen_status, levels = c(
"declined_consent",
"no-show",
"screened")
)) %>%
tidyr::drop_na() %>%
tidyr::complete(screen_status) %>%
tidyr::pivot_wider(
names_from = screen_status,
values_from = n,
values_fill = 0,
values_fn = sum
)
View(screen_status)
runApp()
levels(t$sl_status)
sl_status <- t %>%
select(recruit_date, source, sl_status, n) %>%
mutate(sl_status = factor(
sl_status, levels = levels(t$sl_status)
)) %>%
tidyr::drop_na() %>%
tidyr::complete(sl_status) %>%
tidyr::pivot_wider(
names_from = sl_status,
values_from = n,
values_fill = 0,
values_fn = sum
)
runApp()
runApp()
runApp()
shiny::runApp()
runApp()
runApp()
runApp()
runApp()
runApp()
